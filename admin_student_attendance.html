<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Student Attendance Metrics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: #f4f6f9;
            padding: 40px;
        }

        .page-title {
            font-size: 28px;
            color: #2c5364;
            margin-bottom: 25px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #6366f1;
        }

        .metric-label {
            font-size: 14px;
            color: #64748b;
            margin-top: 5px;
        }

        .search-box {
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="text"] {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 250px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f1f5f9;
            color: #475569;
        }
    </style>
</head>

<body>
    <h1 class="page-title">Global Student Attendance</h1>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-value">92%</div>
            <div class="metric-label">Avg. Present Today</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">1,450</div>
            <div class="metric-label">Total Students</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">12</div>
            <div class="metric-label">Sessions in Progress</div>
        </div>
    </div>

    <div class="search-box">
        <label style="font-weight: 600; color: #475569;">Search Student ID / Dept:</label>
        <input type="text" id="studentSearch" placeholder="Enter ID (e.g. CSE Section A)" onkeyup="filterTable()">
    </div>

    <!-- Edit Modal (Hidden by default) -->
    <div id="editModal"
        style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:30px; box-shadow:0 0 20px rgba(0,0,0,0.2); border-radius:12px; z-index:1000; width: 300px;">
        <h3 style="margin-bottom:20px;">Edit Attendance</h3>
        <input type="hidden" id="editEmail">
        <label>Total Classes:</label>
        <input type="number" id="editTotal"
            style="width:100%; padding:8px; margin-bottom:15px; border:1px solid #ccc; border-radius:6px;">
        <label>Attended Classes:</label>
        <input type="number" id="editAttended"
            style="width:100%; padding:8px; margin-bottom:20px; border:1px solid #ccc; border-radius:6px;">
        <div style="display:flex; gap:10px;">
            <button onclick="saveAttendance()"
                style="flex:1; padding:10px; background:#6366f1; color:white; border:none; border-radius:6px; cursor:pointer;">Save</button>
            <button onclick="closeModal()"
                style="flex:1; padding:10px; background:#ddd; border:none; border-radius:6px; cursor:pointer;">Cancel</button>
        </div>
    </div>
    <div id="modalOverlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;"
        onclick="closeModal()"></div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Global functions for inline onclick handlers
        window.openEditModal = function (email, attended, total) {
            document.getElementById('editEmail').value = email;
            document.getElementById('editTotal').value = total;
            document.getElementById('editAttended').value = attended;

            document.getElementById('editModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }

        window.closeModal = function () {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
        }

        window.saveAttendance = async function () {
            const email = document.getElementById('editEmail').value;
            const newTotal = parseInt(document.getElementById('editTotal').value);
            const newAttended = parseInt(document.getElementById('editAttended').value);

            if (newAttended > newTotal) {
                alert("Attended classes cannot be greater than Total classes!");
                return;
            }

            try {
                const docRef = doc(db, "students", email);
                await updateDoc(docRef, {
                    "attendance.totalClasses": newTotal,
                    "attendance.attended": newAttended
                });
                alert("Attendance updated successfully!");
                closeModal();
                loadStudents(); // Refresh table
            } catch (e) {
                console.error("Error updating attendance:", e);
                alert("Failed to update: " + e.message);
            }
        }

        window.filterTable = function () {
            const input = document.getElementById("studentSearch");
            const filter = input.value.toUpperCase();
            const table = document.getElementById("studentAttendanceTable");
            const tr = table.getElementsByTagName("tr");

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName("td")[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        async function loadStudents() {
            const tableBody = document.querySelector("#studentAttendanceTable tbody");
            tableBody.innerHTML = "<tr><td colspan='4'>Loading students...</td></tr>";

            try {
                const querySnapshot = await getDocs(collection(db, "students"));
                let rows = "";
                let totalPresent = 0;
                let totalStudents = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const email = doc.id;
                    const att = data.attendance || { attended: 0, totalClasses: 0 };

                    const percent = att.totalClasses > 0
                        ? Math.round((att.attended / att.totalClasses) * 100)
                        : 0;

                    // Metrics calculation
                    totalStudents++;
                    if (percent > 75) totalPresent++;

                    rows += `
                        <tr>
                            <td>
                                <strong>${data.profile?.name || email}</strong><br>
                                <span style="font-size:12px; color:#64748b;">${email}</span>
                            </td>
                            <td>${att.attended} / ${att.totalClasses}</td>
                            <td>
                                <span style="
                                    background: ${percent >= 75 ? '#dcfce7' : '#fee2e2'}; 
                                    color: ${percent >= 75 ? '#166534' : '#991b1b'};
                                    padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 13px;">
                                    ${percent}%
                                </span>
                            </td>
                            <td>
                                <button onclick="openEditModal('${email}', ${att.attended}, ${att.totalClasses})" 
                                    style="padding:6px 12px; border:1px solid #6366f1; color:#6366f1; background:transparent; border-radius:6px; cursor:pointer; font-size:13px;">
                                    Edit
                                </button>
                            </td>
                        </tr>
                    `;
                });

                if (totalStudents === 0) {
                    tableBody.innerHTML = "<tr><td colspan='4'>No students found.</td></tr>";
                } else {
                    tableBody.innerHTML = rows;

                    // Update Page Metrics
                    document.querySelector('.metric-value').innerText = totalStudents > 0 ? Math.round((totalPresent / totalStudents) * 100) + "%" : "0%";
                    document.getElementsByClassName('metric-value')[1].innerText = totalStudents;
                }

            } catch (e) {
                console.error("Error loading students:", e);
                tableBody.innerHTML = `<tr><td colspan='4' style="color:red;">Error loading data: ${e.message}</td></tr>`;
            }
        }

        // Initialize
        loadStudents();
    </script>
</body>

</html>