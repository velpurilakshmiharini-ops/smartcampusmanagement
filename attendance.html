<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Student Dashboard</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        body {
            background: #f4f6f9;
        }

        /* Main Content */
        .main {
            width: 100%;
            padding: 40px;
        }

        .page-title {
            font-size: 28px;
            color: #2c5364;
            margin-bottom: 25px;
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(2, minmax(320px, 1fr));
            gap: 35px;
        }

        .card {
            padding: 45px;
            height: 220px;
            border-radius: 18px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card:hover {
            transform: translateY(-8px);
        }

        .card.attendance {
            background: #e3f2fd;
        }

        .card.marks {
            background: #e8f5e9;
        }

        .card.fees {
            background: #fffde7;
        }

        .card.announcements {
            background: #fce4ec;
        }

        .card.library {
            background: #f3e5f5;
        }

        .card h3 {
            font-size: 24px;
            color: #203a43;
        }

        /* Common box */
        .page-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
            margin-bottom: 25px;
        }

        .page-box h2 {
            color: #2c5364;
            margin-bottom: 15px;
        }

        /* Attendance specific */
        .attendance-percentage {
            font-size: 40px;
            font-weight: bold;
            color: #2c5364;
            margin-bottom: 10px;
        }

        .attendance-actions {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            background: #2c5364;
            color: white;
        }

        .action-btn:hover {
            background: #203a43;
        }

        /* Leave form & scan forms */
        textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            font-size: 15px;
            border-radius: 10px;
            border: 1px solid #ccc;
            resize: none;
        }

        video,
        img {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        /* Back button */
        .back-btn {
            margin-top: 30px;
            padding: 12px 28px;
            border: none;
            background: #2c5364;
            color: white;
            border-radius: 8px;
            cursor: pointer;
        }

        .back-btn:hover {
            background: #203a43;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .attendance-actions {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>

    <div class="main" id="content"></div>

    <!-- JavaScript -->
    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Global state for navigating between views
        window.navigate = function (page) {
            if (page === "attendance") loadAttendance();
            if (page === "biometric") loadBiometric();
            if (page === "faceScan") loadFaceScan();
        }

        // Global state to store attendance data
        let attendanceData = {
            percentage: 0,
            totalClasses: 0,
            attended: 0
        };

        // Listen for authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User logged in:", user.email);
                await subscribeToAttendance(user.email);
            } else {
                console.log("No user logged in, redirecting...");
                window.location.href = "login.html";
            }
        });

        async function subscribeToAttendance(email) {
            const docRef = doc(db, "students", email);

            // Listen for real-time updates
            onSnapshot(docRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.attendance) {
                        attendanceData = calculatePercentage(data.attendance);
                        console.log("Data updated:", attendanceData);
                        // If currently on attendance page, refresh UI
                        if (document.querySelector('.attendance-percentage')) {
                            updateAttendanceUI();
                        }
                    }
                } else {
                    console.log("No data found for user, creating default...");
                    await createDefaultData(email);
                }
            });
        }

        async function createDefaultData(email) {
            try {
                const defaultData = {
                    attendance: {
                        attended: 85,
                        totalClasses: 100
                    },
                    profile: {
                        name: email.split("@")[0],
                        email: email
                    }
                };
                await setDoc(doc(db, "students", email), defaultData);
                console.log("Default data created");
            } catch (e) {
                console.error("Error creating default data:", e);
            }
        }

        function calculatePercentage(data) {
            const percentage = data.totalClasses > 0
                ? Math.round((data.attended / data.totalClasses) * 100)
                : 0;
            return { ...data, percentage };
        }

        function updateAttendanceUI() {
            const percentageEl = document.querySelector('.attendance-percentage');
            const totalEl = document.getElementById('totalClassesDisplay');
            const attendedEl = document.getElementById('attendedDisplay');

            if (percentageEl) percentageEl.innerText = `${attendanceData.percentage}%`;
            if (totalEl) totalEl.innerText = `Total Classes: ${attendanceData.totalClasses}`;
            if (attendedEl) attendedEl.innerText = `Attended: ${attendanceData.attended}`;
        }

        /* Attendance page */
        window.loadAttendance = function () {
            document.getElementById("content").innerHTML = `
        <div class="page-title">Attendance</div>

        <div class="page-box">
            <h2>Present Attendance</h2>
            <div class="attendance-percentage">${attendanceData.percentage}%</div>
            <p id="totalClassesDisplay">Total Classes: ${attendanceData.totalClasses}</p>
            <p id="attendedDisplay">Attended: ${attendanceData.attended}</p>
        </div>

        <div class="page-box">
            <h2>Mark Attendance</h2>
            <div class="attendance-actions">
                <button class="action-btn" onclick="navigate('biometric')">Biometric</button>
                <button class="action-btn" onclick="navigate('faceScan')">Face Recognition</button>
            </div>
        </div>

        <div class="page-box">
            <h2>Leave Request</h2>
            <textarea id="leaveReason" placeholder="Enter reason for leave..."></textarea>
            <button class="action-btn" style="margin-top:15px;" onclick="submitLeave()">Submit Request</button>
        </div>
    `;
        }

        /* Biometric page */
        window.loadBiometric = function () {
            document.getElementById("content").innerHTML = `
        <div class="page-title">Biometric Attendance</div>
        <div class="page-box">
            <h2>Place your thumb on the sensor</h2>
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/Fingerprint_icon.svg/1200px-Fingerprint_icon.svg.png" alt="Thumb Impression">
            <button class="action-btn" onclick="submitBiometric()">Scan Thumb</button>
        </div>
        <button class="back-btn" onclick="navigate('attendance')">Back to Attendance</button>
    `;
        }

        /* Face Scan page */
        window.loadFaceScan = function () {
            document.getElementById("content").innerHTML = `
        <div class="page-title">Face Scan Attendance</div>
        <div class="page-box">
            <h2>Scan your face</h2>
            <video id="video" autoplay></video>
            <button class="action-btn" onclick="submitFaceScan()">Submit Scan</button>
        </div>
        <button class="back-btn" onclick="stopCamera(); navigate('attendance')">Back to Attendance</button>
    `;
            startCamera();
        }

        /* Camera functions */
        window.startCamera = function () {
            const video = document.getElementById('video');
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        video.srcObject = stream;
                    })
                    .catch(err => {
                        alert('Camera access denied or unavailable.');
                    });
            } else {
                alert('Camera not supported on this browser.');
            }
        }

        window.stopCamera = function () {
            const video = document.getElementById('video');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        /* Actions */
        window.submitLeave = function () {
            const reason = document.getElementById("leaveReason").value;
            if (reason.trim() === "") {
                alert("Please enter leave reason");
                return;
            }
            alert("Leave request submitted successfully!");
        }

        window.submitBiometric = function () {
            alert("Thumb scan attendance submitted successfully!");
        }

        window.submitFaceScan = function () {
            stopCamera();
            alert("Face scan attendance submitted successfully!");
        }

        // Return button logic (make global if needed by inline onclicks)
        window.backToDashboard = function () {
            window.location.href = "student.html";
        }

        // Initialize view
        loadAttendance();
    </script>

</body>

</html>

</html>